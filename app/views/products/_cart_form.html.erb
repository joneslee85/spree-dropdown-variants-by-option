<% form_for :order, :url => orders_url, :html => {:id => 'cart_form'} do |f| %>
  <% hook :inside_product_cart_form do %>

    <% if product_price(@product) %>
      <% hook :product_price do %>
        <p class="prices">
          <%= t("price") %>
          <br />
          <span class="price selling"><%= product_price(@product) %></span>
        </p>
      <% end %>
    <% end %>

    <% if @product.has_variants? %>
      <div id="product-variant-option-values">
        <% hook :dropdown_variants_by_option_cart_variants do %>
          <%= hidden_field_tag 'product_id', @product.id %>
          <h2>
            <%= t('variants') %>
            &nbsp;
            <%= image_tag "spinner.gif", :plugin=>"spree", :style => "display:none", :id => 'busy_indicator' %>
          </h2>
          <ul>
            <% @product.option_types.each do |option_type| %>
              <li>
                <%= option_type.presentation %><br/>
                <% option_values = instock_option_values(@product, option_type) %>
                <% if option_values.empty? %>
                  <%= t('out_of_stock') %>
                <% else %>
                  <% if option_type.display_as_dropdown %>
                    <%= select_tag "option_values[#{option_type.id}]",
                      options_from_collection_for_select(option_values, :id, :presentation,
                      @selected_variant ? @selected_variant.option_values.find_by_option_type_id(option_type.id).try(:id) : option_values.first.id),
                      :id => 'option_values_select'
                    %>
                  <% else %>
                    <% option_values.each_with_index do |option_value, index| %>
                      <li>
                        <%= radio_button_tag "option_values[#{option_type.id}]",
                          option_value.id,
                          @selected_variant ? option_value.id == @selected_variant.option_values.find_by_option_type_id(option_type.id).try(:id) : option_value.id == option_values.first.id,
                          :id => 'option_values_radio'
                        %>
                        <span class="variant-description">
                          <%= option_value.presentation %>
                        </span>
                      </li>
                    <% end %>
                  <% end %>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>
    <% end%>

    <% hook :dropdown_variants_by_option_cart_add_to_cart do %>
      <% if @product.has_stock? || Spree::Config[:allow_backorders] %>
        <%= text_field_tag (@product.has_variants? ? :quantity : "variants[#{@product.master.id}]"),
          1, :class => "title", :size => 3 %>
        &nbsp;
        <button type='submit' class='large primary' id='add_to_cart_submit'>
          <%= image_tag('/images/add-to-cart.png') + t('add_to_cart') %>
        </button>
      <% else %>
        <%= content_tag('strong', t('out_of_stock')) %>
      <% end %>
    <% end %>

    <% content_for :head do %>
      <script type="text/javascript" charset="utf-8">
        var images = new Array();
        <% @variants.each do |v| %>
          images[<%= v.id.to_s %>] = new Array();
          <% v.images.each_with_index do |image, i| %>
            images[<%= v.id.to_s %>][<%= i %>] = <%= link_to(image_tag(image.attachment.url(:mini)), image.attachment.url(:product)).to_json %>;
          <% end %>
        <% end %>
      </script>
    <% end %>

  <% end %>
<% end %>


<% content_for :head do %>
  <%= javascript_include_tag 'product' %>
<% end %>
